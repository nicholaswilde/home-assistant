---
version: "3"
services:
  homeassistant:
    container_name: homeassistant
    image: ghcr.io/linuxserver/homeassistant:version-2023.8.4
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
    volumes:
      - ./ha:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/ttyUSB1:/dev/ttyUSB1
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/ttyUSB1:/dev/ttyUSB1
    restart: unless-stopped
    privileged: true
    network_mode: host
    depends_on:
      - esphome
      # - wyze-bridge
      - uptime-kuma
      - mosquitto
  esphome:
    container_name: esphome
    image: ghcr.io/esphome/esphome
    volumes:
      - ./esphome:/config
      - /etc/localtime:/etc/localtime:ro
    restart: always
    privileged: true
    network_mode: host
  code-server:
    image: lscr.io/linuxserver/code-server:4.16.1
    container_name: code-server
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - DEFAULT_WORKSPACE=/config/workspace
      - HASS_SERVER=http://192.168.1.143:8123
      - HASS_TOKEN=${HASS_TOKEN}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./ha:/config/workspace
      - ./vscode/data:/config/data
      - ./vscode/extensions:/config/extensions
      - ./vscode/.config:/config/.config
    ports:
      - 8443:8443
    restart: unless-stopped
    privileged: true
    # Node-RED
  nodered:
    container_name: nodered
    image: nodered/node-red:3.0.2-14
    ports:
      - 1880:1880
    volumes:
      # Local path where all Node-RED config will be stored.
      - ./node-red:/data
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - homeassistant
    restart: unless-stopped
    user: ${PUID}:${PGID}
    network_mode: host
  # wyze-bridge:
    # image: mrlt8/wyze-bridge:latest
    # container_name: wyze-bridge
    # restart: unless-stopped
    # network_mode: host
    # ports:
      # # Web UI
      # - 5000:5000
      # # RTMP
      # - 1935:1935
      # # RTSP
      # - 8554:8554
      # # HLS
      # - 8888:8888
      # - 8889:8889 #WebRTC
      # - 8189:8189/udp # WebRTC/ICE
    # environment:
      # - WYZE_EMAIL=ncwilde43@gmail.com
      # - WYZE_PASSWORD=${WYZE_PASSWORD}
      # - TOTP_KEY=${TOTP_KEY}
      # - IGNORE_OFFLINE=true
      # - QUALITY=SD30
      # - SNAPSHOT=RTSP
      # - LOG_LEVEL=debug
      # - WB_IP=192.168.1.143
  uptime-kuma:
    image: louislam/uptime-kuma:1.23.1
    container_name: uptime-kuma
    volumes:
      - ./uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 3001:3001
    restart: always
    network_mode: host
    privileged: true
  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared:2023.8.2
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
  mosquitto:
    image: eclipse-mosquitto:2.0.17
    container_name: mosquitto
    volumes:
      - ./mosquitto:/mosquitto
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
      - ./mosquitto/config:/mosquitto/config
      - /etc/localtime:/etc/localtime:ro
      - ./mosquitto/config/password.txt:/mosquitto/config/password.txt
    ports:
      - 1883:1883
      - 9001:9001
    restart: unless-stopped
  portainer:
    image: portainer/portainer-ce:2.19.0
    ports:
      - 9443:9443
    volumes:
      - ./portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
